<app-header></app-header>

<div class="detail-container">
  <!-- LEFT SIDE -->
  <div class="left-side">
    <!-- Carousel for Images -->
   <!-- Gallery layout directly in property-detail.component.html -->
<div class="property-gallery-container" *ngIf="!isLoading && allImages.length > 0">
  <!-- Main image on the left -->
  <div class="main-image">
    <img [src]="allImages[selectedImageIndex]" alt="Property Image" class="featured-image">
    <div class="image-navigation">
      <button class="nav-btn prev-btn" (click)="prevImage()">
        <i class="bi bi-chevron-left"></i>
      </button>
      <button class="nav-btn next-btn" (click)="nextImage()">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </div>
  
  <!-- Thumbnails grid on the right -->
  <div class="thumbnails-grid">
    <div class="thumbnail-item" *ngFor="let img of allImages.slice(0, 4); let i = index" 
         (click)="selectImage(i)" 
         [class.selected]="selectedImageIndex === i">
      <img [src]="img" alt="Property Thumbnail">
    </div>
    
    <!-- Show more photos button -->
    <div class="thumbnail-item show-more" (click)="openFullGallery()" *ngIf="allImages.length > 4">
      <img [src]="allImages[4]" alt="More Photos" class="more-photos-img">
      <div class="overlay">
        <span>View all {{allImages.length}} photos</span>
      </div>
    </div>
  </div>
  
  <!-- Full gallery modal -->
  <div class="gallery-modal" *ngIf="showFullGallery">
    <div class="modal-header">
      <h3>All Photos ({{allImages.length}})</h3>
      <button class="close-btn" (click)="closeFullGallery()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <div class="modal-image-container">
        <img [src]="allImages[selectedImageIndex]" alt="Property Image" class="modal-main-image">
        <button class="modal-nav-btn modal-prev-btn" (click)="prevImage()">
          <i class="bi bi-chevron-left"></i>
        </button>
        <button class="modal-nav-btn modal-next-btn" (click)="nextImage()">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
      <div class="modal-thumbnails">
        <div class="modal-thumbnail" 
             *ngFor="let img of allImages; let i = index" 
             (click)="selectImage(i)"
             [class.active]="selectedImageIndex === i">
          <img [src]="img" alt="Thumbnail">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Show loading indicator or error message when appropriate -->
<div *ngIf="isLoading" class="loading-spinner">
  Loading property details...
</div>

<div *ngIf="!isLoading && error" class="error-message">
  {{ error }}
</div>

<div *ngIf="!isLoading && allImages.length === 0" class="no-images">
  No images available for this property.
</div>

    <!-- Property Details -->
    <div class="detail-header">
      <h2>{{ property.generalinfo.title }}</h2>
      <p>{{ property.generalinfo.description }}</p>
    </div>
    <h5>Property Details:</h5>
    <div class="details">
      
      <div class="mini-left">
        <ul>
          <li><i class="fas fa-house icon"></i><span class="text"> Type : {{ property.generalinfo.propertyType }}</span>
          </li>
          <li><i class="fa-solid fa-hammer icon"></i><span class="text">Condition : {{ property.generalinfo.PropertyCondition
              }}</span></li>
          <li><i class="fas fa-bed icon"></i><span class="text">Bedrooms {{ property.Specification.bedrooms }} </span>
          </li>
          <li><i class="fas fa-bath icon"></i><span class="text">Bathrooms {{ property.Specification.bathrooms }} </span>
          </li>
          <li><i class="fas fa-expand icon"></i><span class="text">Size : {{ property.Specification.size }} mÂ²</span>
          </li>
          
        </ul>
        <h6><i class="fas fa-handshake"></i> Deal Type: {{ property.generalinfo.deal_type }}</h6>

        <div class="amenities-section" *ngIf="property.Amenities">
          <h6><i class="fas fa-check-circle"></i> Amenities:</h6>
          <!-- Display amenities here -->
          <ul class="amenities-list">
            <li *ngIf="property.Amenities.centralAC">
              <i class="fas fa-snowflake"></i> Central A/C
            </li>
            <li *ngIf="property.Amenities.parking">
              <i class="fas fa-car"></i> Parking
            </li>
            <li *ngIf="property.Amenities.elevator">
              <i class="fas fa-elevator"></i> Elevator
            </li>
            <li *ngIf="property.Amenities.petsAllowed">
              <i class="fas fa-paw"></i> Pets Allowed
            </li>
            <li *ngIf="property.Amenities.conciergeService">
              <i class="fas fa-bell-concierge"></i> Concierge
            </li>
            <li *ngIf="property.Amenities.securityService">
              <i class="fas fa-shield-alt"></i> Security
            </li>
            <li *ngIf="property.Amenities.lobbyInBuilding">
              <i class="fas fa-building"></i> Lobby
            </li>
            <li *ngIf="property.Amenities.maidsRoom">
              <i class="fas fa-broom"></i> Maid's Room
            </li>
            <li *ngIf="property.Amenities.studyRoom">
              <i class="fas fa-book-reader"></i> Study Room
            </li>
            <li *ngIf="property.Amenities.balcony">
              <i class="fas fa-umbrella-beach"></i> Balcony
            </li>
            <li *ngIf="property.Amenities.walkInCloset">
              <i class="fas fa-tshirt"></i> Walk-in Closet
            </li>
            <li *ngIf="property.Amenities.childrensPlayArea">
              <i class="fas fa-baby"></i> Children's Play Area
            </li>
            <li *ngIf="property.Amenities.garden">
              <i class="fas fa-seedling"></i> Garden
            </li>
            <li *ngIf="property.Amenities.barbecueArea">
              <i class="fas fa-drumstick-bite"></i> Barbecue Area
            </li>
            <li *ngIf="property.Amenities.jacuzzi">
              <i class="fas fa-hot-tub"></i> Jacuzzi
            </li>
            <li *ngIf="property.Amenities.sauna">
              <i class="fas fa-water"></i> Sauna
            </li>
            <li *ngIf="property.Amenities.sharedGym">
              <i class="fas fa-dumbbell"></i> Shared Gym
            </li>
            <li *ngIf="property.Amenities.privateGym">
              <i class="fas fa-dumbbell"></i> Private Gym
            </li>
            <li *ngIf="property.Amenities.sharedPool">
              <i class="fas fa-swimming-pool"></i> Shared Pool
            </li>
            <li *ngIf="property.Amenities.privatePool">
              <i class="fas fa-swimming-pool"></i> Private Pool
            </li>
            <li *ngIf="property.Amenities.spa">
              <i class="fas fa-spa"></i> Spa
            </li>
            <li *ngIf="property.Amenities.viewOfWater">
              <i class="fas fa-water"></i> View of Water
            </li>
            <li *ngIf="property.Amenities.viewOfLandmark">
              <i class="fas fa-monument"></i> View of Landmark
            </li>
            <li *ngIf="property.Amenities.nearbyHospitals">
              <i class="fas fa-hospital"></i> Nearby Hospitals
            </li>
            <li *ngIf="property.Amenities.nearbyPublicTransport">
              <i class="fas fa-bus"></i> Public Transport
            </li>
            <li *ngIf="property.Amenities.nearbySchools">
              <i class="fas fa-school"></i> Nearby Schools
            </li>
            <li *ngIf="property.Amenities.nearbyShopping">
              <i class="fas fa-shopping-cart"></i> Nearby Shopping
            </li>
            <!-- Add more amenities as needed -->
          </ul>
        </div>
      </div>

     
      <div class="mini-right">
        <!-- Owner/Agent Card -->
<div class="agent-card">
  <!-- Price Section -->
  <div class="card-section">
    <div class="label">Price</div>
    <div class="price">TND{{property.price.price| number}}</div>
    <div *ngIf="property.generalinfo.deal_type === 'rent'">
      <div class="rent-price">{{property.price.priceunit}}</div>
    </div>
    
  </div>
  
  <!-- Agent Detail Section -->
  <div class="card-section">
    <div class="label">Owner Detail</div>
    <div class="agent-info">
      <img src="/assets/person.png" alt="Agent" class="agent-photo">
      <div class="agent-details">
        <div class="agent-name">{{property.user.name || 'Agent Name'}}</div>
      </div>
    </div>
    <div class="contact-buttons">
      <button class="action-button primary-button" (click)="openEmailModal()">
        <i class="bi bi-envelope"></i> Mail Agent
      </button>
      <button class="action-button outline-button" (click)="callAgent()">
        <i class="bi bi-telephone"></i> Call Agent
      </button>
    </div>
  </div>
  <app-email-modal 
  *ngIf="showEmailModal"
  [propertyId]="property.id"
  [recipientId]="property.user.id"  
  [recipientName]="property.user.name || 'Agent'"
  (close)="closeEmailModal()"
  (emailSent)="onEmailSent($event)">
</app-email-modal>
  
  <!-- Inspection Times Section -->
  <div class="card-section">
    <div class="label">Inspection Times</div>
    <div class="inspection-note">Live inspections only available on:</div>
    <div class="inspection-time">
      <strong>Monday - Friday</strong> at 10:00am - 5:00pm
    </div>
    <button class="action-button primary-button" (click)="openAppointmentForm()">
      <i class="bi bi-calendar-check" ></i> Make Appointment
    </button>
  </div>
    <!-- FIXME: here modal -->
    <div *ngIf="appointmentSuccess" class="alert alert-success mt-3">
      <h4>Appointment Scheduled!</h4>
      <p>Your appointment has been scheduled successfully for 
        {{ scheduledAppointment?.appointmentDate | date:'longDate' }} at 
        {{ scheduledAppointment?.appointmentTime }}.
      </p>
      <p>We'll send you a confirmation email with details.</p>
    </div>
    
    <!-- Appointment form modal overlay -->
    <div class="modal-overlay" *ngIf="showAppointmentForm">
      <div class="modal-container">
        <app-appointment-form
          [propertyId]="property.id"
          (appointmentScheduled)="onAppointmentScheduled($event)"
          (formClosed)="closeAppointmentForm()"
        ></app-appointment-form>
      </div>
    </div>
     
</div>
         <!-- <h5>Owner details:</h5>
          <h6>{{ property.userName }}</h6>  -->    
    </div>
    <div class="calender-mini">
      <div *ngIf="property.generalinfo.deal_type === 'rent'">
        <h5>Select rental period:</h5>
        <app-date-range-picker
          [bookings]="property.bookings"
          (dateRangeChange)="onDateRangeChange($event)">
        </app-date-range-picker>
        
        <div class="booking-summary" *ngIf="selectedDateRange.startDate">
          <h4>Selected Dates:</h4>
          <p>From: {{ selectedDateRange.startDate | date:'mediumDate' }}</p>
          <p *ngIf="selectedDateRange.endDate">To: {{ selectedDateRange.endDate | date:'mediumDate' }}</p>
          <p *ngIf="!selectedDateRange.endDate">Please select an end date</p>
        </div>
        
        <button 
          class="submit-booking"
          [disabled]="!selectedDateRange.startDate || !selectedDateRange.endDate"
          (click)="submitBooking()">
          Book Now
        </button>
      </div>
    </div>

    </div>
    <!-- calender lena -->
    

  </div>


  <!-- RIGHT SIDE map here  -->
  <div class="right-side">
    <div class="map-container" *ngIf="!isLoading && property && property.location">
      
      <app-map2
        [latitude]="property.location.latitude"
        [longitude]="property.location.longitude"
        [propertyTitle]="property.generalinfo.title">
      </app-map2>
      
      <div class="location-address">
        <i class="fas fa-map-marked-alt"></i>
        <span>{{property.location.country}}, {{property.location.city}}, {{property.location.subcity}}</span>
      </div>
    </div>
  </div>
</div>